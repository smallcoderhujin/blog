I"è4<h1 id="æ¶æ„å›¾">æ¶æ„å›¾</h1>
<p><img src="http://langyxxl.dynv6.net:50008/data/User/admin/home/%E6%8A%80%E6%9C%AF/K8S/keyloak.png" alt="keyloak.png" /></p>

<p>OIDCæ˜¯ä¸€ç§ OAuth2 è®¤è¯æ–¹å¼ï¼Œ è¢«æŸäº› OAuth2 æä¾›è€…æ”¯æŒï¼Œä¾‹å¦‚ Azure æ´»åŠ¨ç›®å½•ã€Salesforce å’Œ Googleã€‚ åè®®å¯¹ OAuth2 çš„ä¸»è¦æ‰©å……ä½“ç°åœ¨æœ‰ä¸€ä¸ªé™„åŠ å­—æ®µä¼šå’Œè®¿é—®ä»¤ç‰Œä¸€èµ·è¿”å›ï¼Œ è¿™ä¸€å­—æ®µç§°ä½œ ID Tokenï¼ˆID ä»¤ç‰Œï¼‰ã€‚ ID ä»¤ç‰Œæ˜¯ä¸€ç§ç”±æœåŠ¡å™¨ç­¾åçš„ JSON Web ä»¤ç‰Œï¼ˆJWTï¼‰</p>

<ul>
  <li>ç™»å½•åˆ°ä½ çš„èº«ä»½æœåŠ¡ï¼ˆIdentity Providerï¼‰</li>
  <li>ä½ çš„èº«ä»½æœåŠ¡å°†ä¸ºä½ æä¾› access_tokenã€id_token å’Œ refresh_token</li>
  <li>åœ¨ä½¿ç”¨ kubectl æ—¶ï¼Œå°† id_token è®¾ç½®ä¸º â€“token æ ‡å¿—å€¼ï¼Œæˆ–è€…å°†å…¶ç›´æ¥æ·»åŠ åˆ° kubeconfig ä¸­</li>
  <li>kubectl å°†ä½ çš„ id_token æ”¾åˆ°ä¸€ä¸ªç§°ä½œ Authorization çš„å¤´éƒ¨ï¼Œå‘é€ç»™ API æœåŠ¡å™¨</li>
  <li>API æœåŠ¡å™¨å°†è´Ÿè´£é€šè¿‡æ£€æŸ¥é…ç½®ä¸­å¼•ç”¨çš„è¯ä¹¦æ¥ç¡®è®¤ JWT çš„ç­¾åæ˜¯åˆæ³•çš„</li>
  <li>æ£€æŸ¥ç¡®è®¤ id_token å°šæœªè¿‡æœŸ</li>
  <li>ç¡®è®¤ç”¨æˆ·æœ‰æƒé™æ‰§è¡Œæ“ä½œ</li>
  <li>é‰´æƒæˆåŠŸä¹‹åï¼ŒAPI æœåŠ¡å™¨å‘ kubectl è¿”å›å“åº”</li>
  <li>kubectl å‘ç”¨æˆ·æä¾›åé¦ˆä¿¡æ¯</li>
</ul>

<h1 id="éƒ¨ç½²keycloak">éƒ¨ç½²keycloak</h1>

<h2 id="å‡†å¤‡">å‡†å¤‡</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre># å®‰è£…java
yum install java-11-openjdk
# è·å–æºç åŒ…
wget https://github.com/keycloak/keycloak/releases/download/12.0.1/keycloak-12.0.1.tar.gz
tar xzvf keycloak-12.0.1.tar.gz
cd keycloak-12.0.1
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å¯ç”¨adminç”¨æˆ·">å¯ç”¨adminç”¨æˆ·</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sh bin/add-user-keycloak.sh --user admin
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="åˆ›å»ºè¯ä¹¦æ³¨æ„ä¿®æ”¹ipåœ°å€è¯ä¹¦åˆ›å»ºåˆ°rootsslç›®å½•">åˆ›å»ºè¯ä¹¦ï¼Œæ³¨æ„ä¿®æ”¹ipåœ°å€ï¼Œè¯ä¹¦åˆ›å»ºåˆ°/root/sslç›®å½•</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre>vim /root/makessl.sh

#!/bin/bash

mkdir -p ssl

cat &lt;&lt; EOF &gt; ssl/ca.cnf
[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name

[req_distinguished_name]

[ v3_req ]
basicConstraints = CA:TRUE
EOF

cat &lt;&lt; EOF &gt; ssl/req.cnf
[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name

[req_distinguished_name]

[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[alt_names]
IP.1 = 172.16.41.106   # ä¿®æ”¹æˆå½“å‰æœºå™¨çš„å¤–ç½‘IP,å¦åˆ™ä¼šæŠ¥é”™è¯¯ï¼šx509: cannot validate certificate for 172.16.41.106 because it doesn't contain any IP SANs
EOF

openssl genrsa -out ssl/ca-key.pem 2048
openssl req -x509 -new -nodes -key ssl/ca-key.pem -days 365 -out ssl/ca.pem -subj "/CN=keycloak-ca" -extensions v3_req -config ssl/ca.cnf

openssl genrsa -out ssl/keycloak.pem 2048
openssl req -new -key ssl/keycloak.pem -out ssl/keycloak-csr.pem -subj "/CN=keycloak" -config ssl/req.cnf
openssl x509 -req -in ssl/keycloak-csr.pem -CA ssl/ca.pem -CAkey ssl/ca-key.pem -CAcreateserial -out ssl/keycloak.crt -days 365 -extensions v3_req -extfile ssl/req.cnf
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å¯¼å…¥è¯ä¹¦å¯†ç å°½é‡ä¿æŒä¸€è‡´">å¯¼å…¥è¯ä¹¦ï¼ˆå¯†ç å°½é‡ä¿æŒä¸€è‡´ï¼‰ï¼š</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cd ssl
openssl pkcs12 -export -out keycloak.p12 -inkey keycloak.pem -in keycloak.crt -certfile ca.pem
keytool -importkeystore -deststorepass 'passw0rd' -destkeystore keycloak.jks -srckeystore keycloak.p12 -srcstoretype PKCS12
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å°†è¯ä¹¦æ‹·è´è‡³configurationç›®å½•">å°†è¯ä¹¦æ‹·è´è‡³configurationç›®å½•</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>cp keycloak.jks ../keycloak-12.0.1/standalone/configuration
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="æ£€æŸ¥è¯ä¹¦">æ£€æŸ¥è¯ä¹¦</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre># ç¡®è®¤è¯ä¹¦çš„Alias Nameï¼Œä¼šåœ¨ä¸‹é¢çš„standalone.xmlä¸­å¼•ç”¨
cd ../keycloak-12.0.1/standalone/configuration
keytool -list -keystore keycloak.jks -v
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¿®æ”¹keycloaké…ç½®">ä¿®æ”¹keycloaké…ç½®</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>vim /root/keycloak-12.0.1/standalone/configuration/standalone.xml

&lt;management&gt;
&lt;management&gt;
&lt;security-realms&gt;
    &lt;security-realm name="ApplicationRealm"&gt;
        &lt;server-identities&gt;
         &lt;ssl&gt;
            &lt;keystore path="keycloak.jks" relative-to="jboss.server.config.dir" keystore-password="passw0rd" alias="server" key-password="passw0rd" generate-self-signed-certificate-host="localhost"/&gt;
          &lt;/ssl&gt;
        &lt;/server-identities&gt;
        ...
    &lt;/security-realm&gt;
    &lt;security-realm name="UndertowRealm"&gt;
        &lt;server-identities&gt;
            &lt;ssl&gt;
                &lt;keystore path="keycloak.jks" relative-to="jboss.server.config.dir" keystore-password="passw0rd" /&gt;
            &lt;/ssl&gt;
        &lt;/server-identities&gt;
    &lt;/security-realm&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è¿è¡Œç¨‹åº-æŒ‡å®šå¤–ç½‘ipåœ°å€">è¿è¡Œç¨‹åº, æŒ‡å®šå¤–ç½‘IPåœ°å€</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sh bin/standalone.sh -Djboss.bind.address=172.16.41.106 -Djboss.bind.address.management=172.16.41.106
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è®¿é—®é¡µé¢">è®¿é—®é¡µé¢</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ç™»å½•ï¼šhttps://172.16.41.106:8443/auth/admin
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="åˆå§‹åŒ–keycloak">åˆå§‹åŒ–keycloak</h1>

<h2 id="åˆ›å»ºrealm-kubernetes">åˆ›å»ºrealm kubernetes</h2>
<p>é¡µé¢èœå•æ é¡¶éƒ¨æœ‰ä¸ªâ€œvâ€å›¾æ ‡ï¼Œç‚¹å‡»å¹¶åˆ›å»ºrealmâ€œAdd realmâ€</p>

<h2 id="åˆ›å»ºclient-kubernetes">åˆ›å»ºclient kubernetes</h2>
<p><img src="https://developer.ibm.com/developer/default/articles/cl-lo-openid-connect-kubernetes-authentication2/images/image001.png" alt="create realm kubernetes" /></p>

<p><img src="https://developer.ibm.com/developer/default/articles/cl-lo-openid-connect-kubernetes-authentication2/images/image002.png" alt="secret key" /></p>

<p>æ³¨æ„ï¼š</p>
<ul>
  <li>access typeè¦è®¾ç½®æˆconfidentialï¼Œå¦åˆ™åé¢æ— æ³•è·å–secret key</li>
  <li>valid redirect urléšæ„å¡«å†™ï¼Œè¿™é‡Œå¡«çš„ï¼šhttp://localhost:32768</li>
</ul>

<h2 id="åˆ›å»ºç”¨æˆ·">åˆ›å»ºç”¨æˆ·</h2>

<p>åˆ›å»ºç”¨æˆ·</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>èœå•æ é€‰æ‹©â€œUsersâ€åç‚¹å‡»â€œAdd userâ€ï¼Œåˆ›å»ºç”¨æˆ·ï¼štheoneï¼ˆåå­—éšæ„ï¼Œä¿æŒä¸€è‡´å³å¯ï¼‰
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½®å¯†ç </p>

<p><img src="https://developer.ibm.com/developer/default/articles/cl-lo-openid-connect-kubernetes-authentication2/images/image003.png" alt="" /></p>

<p>æ¿€æ´»ç”¨æˆ·</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>è®¿é—®https://172.16.41.106:8443/auth/admin/kubernetes/console
ä½¿ç”¨theoneç”¨æˆ·ç™»å½•ï¼Œç™»å½•å404 æ²¡æœ‰æƒé™ï¼Œå¯ä»¥å¿½ç•¥ï¼›ç™»å½•åè¦æ±‚é‡æ–°è®¾ç½®å¯†ç ï¼Œè¿˜å¯ä»¥è®¾ç½®æˆä¹‹å‰çš„å¯†ç ï¼Œæ²¡æœ‰å…³ç³»
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="é…ç½®kubernetes">é…ç½®kubernetes</h1>

<p>æ‹·è´è¯ä¹¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>å°†/root/ssl/ca.pemæˆ–è€…keycloak.crtè¯ä¹¦æ–‡ä»¶ï¼Œä»keycloakèŠ‚ç‚¹æ‹·è´åˆ°k8s masterèŠ‚ç‚¹çš„/etc/kubernetes/ssl/ç›®å½•ä¸‹
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ”¹kube apiserveré…ç½®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>vim /etc/kubernetes/manifests/kube-apiserver.yaml
spec:
containers:
- command:
...
- --oidc-issuer-url=https://172.16.41.106:8443/auth/realms/kubernetes
- --oidc-client-id=kubernetes
- --oidc-username-claim=preferred_username
- --oidc-username-prefix=-
- --oidc-ca-file=/etc/kubernetes/pki/ca.pem
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶kube api serverä¼šè‡ªåŠ¨é‡å¯ï¼Œæ³¨æ„æŸ¥çœ‹å®¹å™¨æ—¥å¿—</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl logs kube-apiserver-xxx -f -n kube-system
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æƒé™è®¾ç½®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>#cat rolebing.yaml

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-readonly
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: theone   # æ›¿æ¢æˆä¹‹å‰åœ¨keycloakä¸­åˆ›å»ºçš„ç”¨æˆ·å
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="æµ‹è¯•è„šæœ¬">æµ‹è¯•è„šæœ¬</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>import requests
from pprint import pprint
import json


auth_url = 'https://179.18.3.180:6443'
headers = {'Connection': 'Keep-Alive'}

def get_token():
    url = 'https://172.16.41.106:8443/auth/realms/kubernetes/protocol/openid-connect/token'
    req = requests.post(url, data={'client_id': 'kubernetes',
                                   'client_secret': 'aa3e7e64-d947-493e-93ca-d43faae6585e',
                                   'response_type': 'code token',
                                   'grant_type': 'password',
                                   'username': 'theone',
                                   'password': 'test',
                                   'scope': 'openid'},
                       verify=False)
    r = json.loads(req.content)
    pprint(r)
    return r


def list_ingress(tk):
    req_url = '%s/api/v1/pods' % auth_url
    headers['Authorization'] = 'Bearer %s' % tk
    print(req_url, headers)
    req = requests.get(req_url, headers=headers, verify=False)
    pprint(json.loads(req.content))

tokes = get_token()
list_ingress(tokes['id_token'])
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒ</p>
<ul>
  <li>https://developer.ibm.com/zh/depmodels/cloud/articles/cl-lo-openid-connect-kubernetes-authentication/</li>
  <li>https://developer.ibm.com/zh/articles/cl-lo-openid-connect-kubernetes-authentication2/</li>
</ul>
:ET
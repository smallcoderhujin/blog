I"İ0<h2 id="æ¶æ„">æ¶æ„</h2>
<p><img src="https://img.draveness.me/2018-11-07-coredns-architecture.png" alt="" /></p>

<h2 id="æ­å»º">æ­å»º</h2>

<p>æ­£å¸¸ä½¿ç”¨kubeadmç­‰å·¥å…·éƒ¨ç½²çš„é›†ç¾¤ä¸­é»˜è®¤éƒ½å·²ç»éƒ¨ç½²æœ‰corednsï¼Œä»¥ä¸‹ä¸ºæ‰‹åŠ¨éƒ¨ç½²çš„æµç¨‹ï¼š</p>
<ul>
  <li>åˆ›å»ºä¸€ä¸ªserviceaccountç”¨æ¥åšé‰´æƒç”¨</li>
  <li>åˆ›å»ºclusterroleå¯¹è±¡system:coredns</li>
  <li>ç»‘å®šserviceaccountå’Œclusterrole</li>
  <li>åˆ›å»ºcorednsçš„é…ç½®configmapï¼Œåœ¨åé¢åˆ›å»ºdeploymentæ—¶å¼•ç”¨ã€‚è¿™é‡Œéœ€è¦æ³¨æ„æ ¹æ®éœ€è¦ä¿®æ”¹forwardå’Œpodså±æ€§</li>
  <li>åˆ›å»ºcorednsçš„deploymentï¼Œå®¹å™¨å¼•ç”¨å¯¹åº”çš„configmapï¼Œé™åˆ¶èµ„æºã€æš´éœ²ç«¯å£ã€é…ç½®è°ƒåº¦ç­–ç•¥ç­‰åˆ°</li>
  <li>åˆ›å»ºserviceï¼Œè®¾ç½®podselectorå’Œç«¯å£</li>
</ul>

<p>coredns.yaml</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
</pre></td><td class="rouge-code"><pre>cat coredns.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
rules:
- apiGroups:
  - ""
  resources:
  - endpoints
  - services
  - pods
  - namespaces
  verbs:
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/name: "CoreDNS"
spec:
  # replicas: not specified here:
  # 1. Default is 1.
  # 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: coredns
      tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Exists"
      nodeSelector:
        kubernetes.io/os: linux
      affinity:
         podAntiAffinity:
           preferredDuringSchedulingIgnoredDuringExecution:
           - weight: 100
             podAffinityTerm:
               labelSelector:
                 matchExpressions:
                   - key: k8s-app
                     operator: In
                     values: ["kube-dns"]
               topologyKey: kubernetes.io/hostname
      containers:
      - name: coredns
        image: coredns/coredns:1.8.0
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 170Mi
          requests:
            cpu: 100m
            memory: 70Mi
        args: [ "-conf", "/etc/coredns/Corefile" ]
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: true
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: true
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8181
            scheme: HTTP
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/port: "9153"
    prometheus.io/scrape: "true"
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: "true"
    kubernetes.io/name: "CoreDNS"
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: CLUSTER_DNS_IP
  ports:
  - name: dns
    port: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    protocol: TCP
  - name: metrics
    port: 9153
    protocol: TCP
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ›å»ºåï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>[root@none-nested-master hujin]# kubectl get service -n kube-system
NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
k8s-keystone-auth-service   ClusterIP   10.233.40.69   &lt;none&gt;        8443/TCP        4d20h
kube-dns                    ClusterIP   10.233.0.110   &lt;none&gt;        53/UDP,53/TCP   7d2h
[root@none-nested-master hujin]# kubectl get deploy -n kube-system
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
coredns             1/1     1            1           7d2h
k8s-keystone-auth   1/1     1            1           4d18h
[root@none-nested-master hujin]# kubectl get deploy -n kube-system
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
coredns             1/1     1            1           7d2h
k8s-keystone-auth   1/1     1            1           4d18h
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ”¹é›†ç¾¤cluster dnsé…ç½®ï¼Œè¿™é‡Œå¦‚æœé›†ç¾¤é»˜è®¤éƒ¨ç½²corednsï¼Œä¼šè®¾ç½®æˆpodçš„ipï¼Œä¿®æ”¹åï¼Œæ–°å»ºçš„podä¸­/etc/resolv.confæ–‡ä»¶ä¼šè·å–é…ç½®åçš„ip</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>vim /etc/kubernetes/kubelet-config.yaml
clusterDNS:
- 10.233.0.110

service kubelet restart
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>

<h3 id="é€šè¿‡ä½¿ç”¨busyboxä¸­çš„nslookupå‘½ä»¤è®¿é—®åŸŸå">é€šè¿‡ä½¿ç”¨busyboxä¸­çš„nslookupå‘½ä»¤è®¿é—®åŸŸå</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>cat busybox.yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox2
  namespace: default
spec:
  containers:
  - image: aarch64/busybox
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
    name: busybox2
  restartPolicy: Always
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è®¿é—®service">è®¿é—®service</h3>

<p>æ ¼å¼ï¼š[svc-name].[namespace].svc.[self-defined cluster domain]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre># æŸ¥è¯¢åŸŸåï¼š
/ # nslookup my-apache.default.svc.cluster.local
Server:    10.233.0.110
Address 1: 10.233.0.110 kube-dns.kube-system.svc.cluster.local

Name:      my-apache.default.svc.cluster.local
Address 1: 10.233.4.36 my-apache.default.svc.cluster.local

# é€šè¿‡åŸŸåè®¿é—®æœåŠ¡
sh-4.2# curl my-apache.default.svc.cluster.local
&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è®¿é—®pod">è®¿é—®pod</h3>

<p>æ ¼å¼ï¼š[pod-ip].[namespace].pod.[self-defined cluster domain]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre># æŸ¥è¯¢åŸŸå
/ # nslookup 10-233-127-250.default.pod.cluster.local
Server:    10.233.0.110
Address 1: 10.233.0.110 kube-dns.kube-system.svc.cluster.local

Name:      10-233-127-250.default.pod.cluster.local
Address 1: 10.233.127.250 10-233-127-250.my-apache.default.svc.cluster.local

# é€šè¿‡åŸŸåè®¿é—®æœåŠ¡
sh-4.2# curl 10-233-127-250.default.pod.cluster.local
&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è‡ªå®šä¹‰åŸŸå">è‡ªå®šä¹‰åŸŸå</h2>

<p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨corednsæ˜¯åœ¨k8sä¸­çš„ï¼Œä½†æ˜¯å®é™…corednsæä¾›äº†å¾ˆå¤šæ’ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡hostsæ’ä»¶å®ç°è‡ªå®šä¹‰åŸŸåçš„åŠŸèƒ½,</p>

<p>hostsæ’ä»¶çš„é…ç½®å‚æ•°å‚è€ƒï¼š
    hosts [FILE [ZONESâ€¦]] {
        [INLINE]
        ttl SECONDS
        no_reverse
        reload DURATION
        fallthrough [ZONESâ€¦]
    }</p>

<blockquote>
  <p>FILEï¼šéœ€è¦è¯»å–ä¸è§£æçš„hostsæ–‡ä»¶ï¼›å¦‚æœçœç•¥ï¼Œé»˜è®¤å–å€¼â€/etc/hostsâ€ï¼›æ¯5sæ‰«æä¸€æ¬¡hostsæ–‡ä»¶çš„å˜æ›´ã€‚</p>
</blockquote>

<blockquote>
  <p>ZONESï¼šå¦‚æœä¸ºç©ºï¼Œå–é…ç½®å—ä¸­çš„zoneã€‚</p>
</blockquote>

<blockquote>
  <p>INLINEï¼šå®¿ä¸»æœºhostsæ–‡ä»¶åœ¨corefileä¸­çš„å†…è”ï¼›åœ¨â€fallthroughâ€ä¹‹å‰çš„æ‰€æœ‰â€INLINEâ€éƒ½å¯è§†ä¸ºhostsæ–‡ä»¶çš„é™„åŠ å†…å®¹ï¼Œhostsæ–‡ä»¶ä¸­ç›¸åŒæ¡ç›®å°†è¢«è¦†ç›–ï¼Œä»¥â€INLINEâ€ä¸ºå‡†ã€‚</p>
</blockquote>

<blockquote>
  <p>fallthroughï¼šå¦‚æœzoneåŒ¹é…ä¸”æ— æ³•ç”Ÿæˆè®°å½•ï¼Œå°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ’ä»¶ï¼›å¦‚æœçœç•¥ï¼Œå¯¹æ‰€æœ‰zonesæœ‰æ•ˆï¼Œå¦‚æœåˆ—å‡ºç‰¹å®šzoneï¼Œåˆ™åªæœ‰åˆ—å‡ºçš„zoneå—åˆ°å½±å“ã€‚</p>
</blockquote>

<p>ä¿®æ”¹corednsçš„configmapï¼Œè¿™é‡Œä¿®æ”¹å®Œæˆåéœ€è¦ç­‰å¾…çŸ­æš‚æ—¶é—´é‡æ–°åŠ è½½é…ç½®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>kubectl edit configmaps -n kube-system coredns
apiVersion: v1
data:
  Corefile: |
    .:53 {
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        hosts /etc/hosts {
           10.244.0.4 nginx.me.test
           fallthrough
        }
    }

[root@hujin-test ~]# kubectl exec -it my-busybox-6dffd8765-pkcl7 -- sh
/ # ping nginx.me.test
PING nginx.me.test (10.244.0.4): 56 data bytes
64 bytes from 10.244.0.4: seq=0 ttl=63 time=0.281 ms
64 bytes from 10.244.0.4: seq=1 ttl=63 time=0.254 ms
64 bytes from 10.244.0.4: seq=2 ttl=63 time=0.195 ms
64 bytes from 10.244.0.4: seq=3 ttl=63 time=0.166 ms
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
  <li>https://github.com/coredns/deployment/tree/master/kubernetes</li>
  <li>https://coredns.io/plugins/hosts/</li>
</ul>
:ET
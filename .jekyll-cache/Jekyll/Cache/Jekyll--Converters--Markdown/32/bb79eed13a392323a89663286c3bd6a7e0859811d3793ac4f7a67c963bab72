I"õ!<h2 id="åŠŸèƒ½ä»‹ç»">åŠŸèƒ½ä»‹ç»</h2>

<p><img src="/blog/img/neuvector_tcpdump.png" alt="neuvector_pcap" /></p>

<p>æŠ“åŒ…åŠŸèƒ½æ˜¯é’ˆå¯¹å®¹å™¨çš„åŠŸèƒ½ï¼Œç”¨æˆ·åœ¨ç•Œé¢é€‰æ‹©æŸä¸ªå®¹å™¨ç‚¹å‡»æŠ“åŒ…åŠŸèƒ½ï¼Œå¯ä»¥æ§åˆ¶æŠ“åŒ…å¼€å§‹å’Œç»“æŸï¼Œå¯ä»¥é€‰æ‹©æŠ“åŒ…æ—¶é—´ï¼›å®Œæˆåå¯ä»¥ä¸‹è½½å¯¹åº”çš„pcapæ ¼å¼çš„æ–‡ä»¶ï¼Œ
åœ¨æœ¬åœ°çš„wiresharkä¸­ç›´æ¥æ‰“å¼€è¿›è¡Œåˆ†æã€‚åº•å±‚å®é™…è¿˜æ˜¯é€šè¿‡è¿›å…¥å®¹å™¨çš„ç½‘ç»œnamespaceï¼Œæ‰§è¡Œtcpdumpå‘½ä»¤æ¥å®ç°ã€‚</p>

<p>è¯´æ˜ä¸‹ï¼šhostnetworkçš„å®¹å™¨æš‚ä¸æ”¯æŒæŠ“åŒ…åŠŸèƒ½</p>

<p>APIæ¥å£ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>neuvector\controller\rest\rest.go:1517

r.GET("/v1/sniffer", handlerSnifferList)
r.GET("/v1/sniffer/:id", handlerSnifferShow)
r.POST("/v1/sniffer", handlerSnifferStart)
r.PATCH("/v1/sniffer/stop/:id", handlerSnifferStop)
r.DELETE("/v1/sniffer/:id", handlerSnifferDelete)
r.GET("/v1/sniffer/:id/pcap", handlerSnifferGetFile)
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>

<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯handlerSnifferStartçš„ä»£ç æµç¨‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>func handlerSnifferStart(w http.ResponseWriter, r *http.Request, ps httprouter.Params) {
  ...
  # ä»requestä¸­è·å–å¯¹åº”çš„å‚æ•°ï¼Œè¿™é‡Œæ˜¯workloadidï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„pauseå®¹å™¨çš„container id
  query := restParseQuery(r)

  # è·å–å®¹å™¨idå‚æ•°ï¼Œå¹¶æ ¹æ®å®¹å™¨idè·å–å¯¹åº”çš„agentid
  agentID, wlID, err := getAgentWorkloadFromFilter(query.filters, acc)
  if err != nil {
      restRespNotFoundLogAccessDenied(w, login, err)
      return
  }

  // Check if we can config workload
  wl, err := cacher.GetWorkloadBrief(wlID, "", acc)
  if wl == nil {
      restRespNotFoundLogAccessDenied(w, login, err)
      return
  } else if !acc.Authorize(&amp;share.CLUSSnifferDummy{WorkloadDomain: wl.Domain}, nil) {
      restRespAccessDenied(w, login)
      return
  }
  ...

  args := proc.Sniffer
  req := &amp;share.CLUSSnifferRequest{WorkloadID: wlID, Cmd: share.SnifferCmd_StartSniffer}
  ...

  res, err := rpc.SnifferCmd(agentID, req)
  ...
  restRespSuccess(w, r, &amp;resp, acc, login, &amp;proc, "Start sniffer")
}
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>ä»£ç ä¼šä»requestä¸­è·å–éœ€è¦æŠ“åŒ…çš„å®¹å™¨id</li>
  <li>getAgentWorkloadFromFilterä¸­è·å–å®¹å™¨idå¹¶æŸ¥è¯¢å¯¹åº”çš„agent id</li>
  <li>GetWorkloadBrief è·å–æŒ‡å®šå®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶æ ¡éªŒå®¹å™¨æ˜¯å¦å…è®¸æŠ“åŒ…</li>
  <li>SnifferCmd é€šè¿‡grpcè°ƒç”¨å¯¹åº”agentçš„æŠ“åŒ…æ¥å£ï¼Œè¿™é‡Œä¼šæå‰é…ç½®ä¸€äº›æŠ“åŒ…çš„å‚æ•°ï¼ŒåŒ…æ‹¬æ–‡ä»¶åç§°ã€æ–‡ä»¶å¤§å°ï¼ˆé»˜è®¤2Mï¼‰ã€æŠ“åŒ…æ—¶é—´ç­‰ç­‰</li>
</ul>

<p>æˆ‘ä»¬åœ¨agentä¸­æŸ¥çœ‹å¯¹åº”çš„è°ƒç”¨æ¥å£SnifferCmdï¼Œæ–‡ä»¶ä½ç½®ï¼šneuvector\agent\service.go:830</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>func (rs *RPCService) SnifferCmd(ctx context.Context, req *share.CLUSSnifferRequest) (*share.CLUSSnifferResponse, error) {
    if req.Cmd == share.SnifferCmd_StartSniffer {
        id, err := startSniffer(req)
        return &amp;share.CLUSSnifferResponse{ID: id}, err
    } else if req.Cmd == share.SnifferCmd_StopSniffer {
        return &amp;share.CLUSSnifferResponse{}, stopSniffer(req.ID)
    } else if req.Cmd == share.SnifferCmd_RemoveSniffer {
        return &amp;share.CLUSSnifferResponse{}, removeSniffer(req.ID)
    }
    return &amp;share.CLUSSnifferResponse{}, grpc.Errorf(codes.InvalidArgument, "Invalid sniffer command")
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­æŸ¥çœ‹å¯¹åº”çš„startSnifferæ–¹æ³•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>func startSniffer(info *share.CLUSSnifferRequest) (string, error) {
    var pid int

    gInfoRLock()
    c, ok := gInfo.activeContainers[info.WorkloadID]
    ...

    proc := &amp;procInfo{
        workload:   info.WorkloadID,
        fileNumber: uint(info.FileNumber),
        duration:   uint(info.DurationInSecond),
    }

    key := generateSnifferID()

    proc.fileName, proc.args = parseArgs(info, key[:share.SnifferIdAgentField])
    _, err := startSnifferProc(key, proc, pid)
    if err != nil {
        return "", grpc.Errorf(codes.Internal, err.Error())
    } else {
        return key, nil
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>è¿™é‡Œæ ¹æ®å®¹å™¨idæˆ–è€…å†…å­˜ä¸­å®¹å™¨å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®é™…æ˜¯é€šè¿‡ç‹¬ç«‹çº¿ç¨‹ç›‘å¬èŠ‚ç‚¹çš„runtimeç»´æŠ¤çš„ä¿¡æ¯</li>
  <li>generateSnifferID è¿™ä¸ªæ˜¯æ ¹æ®agent idç”Ÿæˆä¸€ä¸ªidä½œä¸ºæ–‡ä»¶åç§°çš„ä¸€éƒ¨åˆ†</li>
</ul>

<p>ç”Ÿæˆtcpdumpå‘½ä»¤ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>func parseArgs(info *share.CLUSSnifferRequest, keyname string) (string, []string) {
    ...
    filename = defaultPcapDir + keyname + "_"
    filenumber = fmt.Sprintf("%d", info.FileNumber)
    filesize = fmt.Sprintf("%d", info.FileSizeInMB)
    ...

    tcpdumpCmd := []string{"-i", "any", "-U", "-C"}
    cmdStr = append(tcpdumpCmd, filesize, "-w", filename, "-W", filenumber)
    ...
    return filename, cmdStr
}
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>parseArgsç”¨æ¥ç”Ÿæˆå®Œæ•´çš„æ–‡ä»¶åç§°ï¼Œå¹¶å‡†å¤‡å…·ä½“çš„tcpdumpå‘½ä»¤ï¼Œå®Œæ•´çš„å‘½ä»¤ç±»ä¼¼ï¼š tcpdump -i any -U -C 2 -w /var/neuvector/pcap/0a5bdf2c_0</li>
</ul>

<p>ä¸‹é¢å°±æ˜¯è¿›å…¥å®¹å™¨çš„network namespaceç„¶åæ‰§è¡Œtcpdumpå‘½ä»¤</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>func startSnifferProc(key string, proc *procInfo, pid int) (string, error) {
    ...

    var script string
    if proc.duration &gt; 0 {
        script = fmt.Sprintf("timeout %d ", proc.duration)
    }
    script += "tcpdump " + strings.Join(proc.args, " ")
    log.WithFields(log.Fields{"key": key, "cmd": script}).Debug()

    proc.cmd = exec.Command(system.ExecNSTool, system.NSActRun, "-i", "-n", global.SYS.GetNetNamespacePath(pid))
    proc.cmd.SysProcAttr = &amp;syscall.SysProcAttr{Setsid: true}
    proc.cmd.Stderr = &amp;proc.errb
    stdin, err := proc.cmd.StdinPipe()
    if err != nil {
        e := fmt.Errorf("Open nsrun stdin error")
        log.WithFields(log.Fields{"error": err}).Error(e)
        return "", e
    }

    err = proc.cmd.Start()
    if err != nil {
        e := fmt.Errorf("Failed to start sniffer")
        log.WithFields(log.Fields{"error": err}).Error(e)
        return "", e
    }

    pgid := proc.cmd.Process.Pid
    global.SYS.AddToolProcess(pgid, pid, "sniffer", script)

    io.WriteString(stdin, script)
    stdin.Close()

    ...
    return status, err
}
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>è¿™é‡Œå°±æ˜¯é€šè¿‡nstoolå·¥å…·è¿›å…¥å®¹å™¨network namespace, å°†tcpdumpå‘½ä»¤ä½œä¸ºstdinåœ¨namespaceä¸­æ‰§è¡Œ</li>
  <li>å®Œæ•´çš„å‘½ä»¤ç±»ä¼¼ï¼šecho â€œtcpdump -i any -U -C 2 -w /var/neuvector/pcap/xxx  -W 5â€ | ./nstools run -i -n /proc/2271/ns/net</li>
  <li>nstoolsè¿™ä¸ªå·¥å…·ç±»ä¼¼nsenterï¼Œä¸ºäº†å®‰å…¨å·¥å…·å†…éƒ¨ä¼šæ ¡éªŒè°ƒç”¨æ–¹å¿…é¡»æ˜¯neuvector agentæœåŠ¡ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ˜¯ä¼šå¤±è´¥çš„</li>
  <li>ç›‘å¬tcpdumpè¿›ç¨‹çŠ¶æ€å¹¶è¿”å›çŠ¶æ€ä¿¡æ¯</li>
</ul>

<p>å…¶ä»–æ–¹æ³•æ¯”å¦‚stopã€ä¸‹è½½æŠ“åŒ…æ–‡ä»¶çš„è°ƒç”¨è·¯å¾„æ˜¯ç±»ä¼¼çš„</p>

<p>nstoolså·¥å…·ä½¿ç”¨ï¼ˆç§»é™¤çˆ¶è¿›ç¨‹æ ¡éªŒåï¼‰ï¼š
<img src="/blog/img/neuvector_nstools.png" alt="neuvector_pcap" /></p>

:ET
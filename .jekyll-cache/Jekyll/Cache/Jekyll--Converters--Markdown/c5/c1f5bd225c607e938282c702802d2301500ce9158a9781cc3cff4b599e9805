I"½-<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>æœ€è¿‘æœ‰è·ŸåŒäº‹è®¨è®ºcalicoçš„ç½‘ç»œå®ç°çš„è¯é¢˜ï¼Œè¯´calico è®¾è®¡å¾ˆå·§å¦™ï¼ŒæŠŠ 2-3å±‚éƒ½ç»™å¤„ç†æˆäº†3å±‚ï¼Œæƒ³çœ‹çœ‹æ˜¯å¦‚ä½•å®ç°çš„</p>

<h2 id="å®ç°">å®ç°</h2>
<p>æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°æœ‰å‡ ä¸ªè§£é‡Šï¼Œé€šè¿‡è¿™å‡ ä¸ªè§£é‡Šæˆ‘ä»¬å®é™…çœ‹çœ‹Calicoä¸­å¦‚ä½•å®ç°å°†2-3å±‚æµé‡éƒ½å¤„ç†æˆ3å±‚çš„</p>

<p>Why does my container have a route to 169.254.1.1?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>In a Calico network, each host acts as a gateway router for the workloads that it hosts. In container deployments, Calico uses 169.254.1.1 as the address for the Calico router. By using a link-local address, Calico saves precious IP addresses and avoids burdening the user with configuring a suitable address.

While the routing table may look a little odd to someone who is used to configuring LAN networking, using explicit routes rather than subnet-local gateways is fairly common in WAN networking.
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>ä¸ºä»€ä¹ˆå®¹å™¨ä¸­æœ‰ä¸€æ¡åˆ°169.254.1.1çš„è·¯ç”±è§„åˆ™</p>
</blockquote>

<blockquote>
  <p>ç®€å•ç¿»è¯‘ï¼šåœ¨Calicoç½‘ç»œä¸­ï¼Œæ¯å°ä¸»æœºéƒ½å……å½“å®¹å™¨çš„ç½‘å…³ï¼ˆè·¯ç”±å™¨ï¼‰ã€‚åœ¨å®¹å™¨éƒ¨ç½²ä¸­ï¼ŒCalicoä½¿ç”¨169.254.1.1ä½œä¸ºç½‘å…³è·¯ç”±å™¨çš„åœ°å€ã€‚
é€šè¿‡ä½¿ç”¨link-localåœ°å€ï¼ŒCalicoèŠ‚çœäº†å®è´µçš„IPåœ°å€ï¼Œå¹¶é¿å…äº†ç”¨æˆ·é…ç½®åˆé€‚åœ°å€çš„è´Ÿæ‹…ã€‚
è™½ç„¶å¯¹äºä¹ æƒ¯äºé…ç½®LANç½‘ç»œçš„äººæ¥è¯´ï¼Œè·¯ç”±è¡¨å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä½†åœ¨WANç½‘ç»œä¸­ï¼Œä½¿ç”¨æ˜¾å¼è·¯ç”±è€Œä¸æ˜¯å­ç½‘æœ¬åœ°ç½‘å…³æ˜¯ç›¸å½“å¸¸è§çš„ã€‚</p>
</blockquote>

<p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å®¹å™¨ä¸­çš„ç½‘å¡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>[root@node2 ~]# docker exec -it d3d044626d12 sh
# ip a 
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
4: eth0@if55: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default 
    link/ether d6:84:ed:49:d4:cf brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 11.244.104.3/32 brd 11.244.104.3 scope global eth0
       valid_lft forever preferred_lft forever
# ip r
default via 169.254.1.1 dev eth0 
169.254.1.1 dev eth0 scope link 
# exit
[root@node2 ~]# ip a |grep 55
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 655
36 qdisc noqueue state UNKNOWN group default qlen 1000
    inet 179.20.23.41/24 brd 179.20.23.255 scope global noprefixroute ens160
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
55: calic4eb42dc79d@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP group default
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å®¹å™¨ä¸­æœ‰ä¸€å¼ eth0ç½‘å¡ï¼Œipæ˜¯11.244.104.3ï¼Œå¯¹åº”çš„å¦ä¸€ç«¯vethè®¾å¤‡æ˜¯calic4eb42dc79d</li>
  <li>å®¹å™¨ä¸­åªæœ‰ä¸¤æ¡è·¯ç”±è§„åˆ™ï¼Œåˆ†åˆ«æ˜¯é»˜è®¤è·¯ç”±å’Œä¸€æ¡32ä½è·¯ç”±</li>
  <li>ä¸‹ä¸€è·³æ˜¯169.254.1.1</li>
</ul>

<p>ä»ä¸Šé¢å®¹å™¨å†…çš„æƒ…å†µå¯ä»¥çœ‹åˆ°ï¼Œä»»ä½•å®¹å™¨æµé‡éƒ½æ˜¯å‘é€ç»™169.254.1.1è¿™ä¸ªç½‘å…³çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘å…³åœ¨å“ªé‡Œï¼ŒåŒèŠ‚ç‚¹å®¹å™¨å¦‚ä½•é€šä¿¡ï¼Œè·¨èŠ‚ç‚¹å®¹å™¨å¦‚ä½•é€šä¿¡å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹ç¬¬äºŒä¸ªé—®é¢˜</p>

<ol>
  <li>
    <p>Why canâ€™t I see the 169.254.1.1 address mentioned above on my host?</p>

    <p>Calico tries hard to avoid interfering with any other configuration on the host. Rather than adding the gateway address to the host side of each workload interface, Calico sets the proxy_arp flag on the interface. This makes the host behave like a gateway, responding to ARPs for 169.254.1.1 without having to actually allocate the IP address to the interface.</p>
  </li>
</ol>

<blockquote>
  <p>ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨hostä¸Šæ²¡æœ‰æ‰¾åˆ°ipåœ°å€æ˜¯169.254.1.1çš„è®¾å¤‡ï¼Ÿ</p>
</blockquote>

<blockquote>
  <p>ç®€å•ç¿»è¯‘æ˜¯ï¼šCalicoåŠªåŠ›é¿å…å¹²æ‰°ä¸»æœºä¸Šçš„é…ç½®ã€‚Calicoæ²¡æœ‰å°†ç½‘å…³åœ°å€æ·»åŠ åˆ°æ¯ä¸ªå®¹å™¨ç½‘å¡çš„ä¸»æœºç«¯ï¼Œè€Œæ˜¯åœ¨ä¸»æœºç«¯è®¾å¤‡ä¸Šè®¾ç½®proxy_arpæ ‡å¿—ã€‚
è¿™ä½¿å¾—ä¸»æœºèƒ½åƒç½‘å…³ä¸€æ ·å“åº”169.254.1.1çš„ARPï¼Œè€Œä¸å¿…å®é™…å°†IPåœ°å€åˆ†é…ç»™æ¥å£ã€‚</p>
</blockquote>

<p>ç¨å¾®è§£é‡Šä¸‹ï¼š</p>

<ul>
  <li>Calicoä¸­å®¹å™¨ç½‘å¡ç±»å‹æ˜¯vethï¼Œå…¶ä¸­ä¸€ç«¯åœ¨å®¹å™¨å†…ï¼Œå¦ä¸€ç«¯åœ¨ä¸»æœºä¸Š</li>
  <li>è¿™é‡Œé€šè¿‡è®¾ç½®ä¸»æœºç«¯è®¾å¤‡ï¼Œå¼€å¯proxy_arpï¼ŒåŒæ—¶è®¾ç½®è¿™ä¸ªè®¾å¤‡çš„macåœ°å€å›ºå®šä¸ºee:ee:ee:ee:ee:ee</li>
  <li>è¿™æ ·ä»»æ„å‘é€è¿™ä¸ªè®¾å¤‡ä¸Šçš„arpè¯·æ±‚ï¼Œè¯¥è®¾å¤‡éƒ½ä¼šå‘é€arp replyåŒ…ï¼Œè¡¨ç¤ºè‡ªå·±æ˜¯ç½‘å…³ï¼Œå¯ä»¥å°†åé¢çš„åŒ…å‘é€ç»™æˆ‘ï¼Œæˆ‘ç»™ä½ ä»¬è½¬å‘</li>
</ul>

<p><img src="/blog/img/arp.png" alt="arpæµç¨‹" /></p>

<p>å®é™…åœ¨å®¹å™¨ä¸­æŸ¥çœ‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>[root@node2 ~]# ip link show calic4eb42dc79d
55: calic4eb42dc79d@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP mode DEFAULT group default 
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 7
[root@node2 ~]# sysctl -a  |grep calic4eb42dc79d |grep proxy_arp
net.ipv4.conf.calic4eb42dc79d.proxy_arp = 1
net.ipv4.conf.calic4eb42dc79d.proxy_arp_pvlan = 0
[root@node2 ~]# ip r |grep calic4eb42dc79d
11.244.104.3 dev calic4eb42dc79d scope link 
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>calic4eb42dc79dè¿™ä¸ªè®¾å¤‡çš„macåœ°å€æ˜¯ee:ee:ee:ee:ee:ee</li>
  <li>calic4eb42dc79dè®¾å¤‡å¼€å¯äº†arpä»£ç­”åŠŸèƒ½ï¼Œè¿™æ ·ä»»æ„å‘é€åˆ°è¿™ä¸ªè®¾å¤‡ä¸Šçš„arpï¼Œä¸”ç›®çš„macåœ°å€æ˜¯ee:ee:ee:ee:ee:eeçš„è¯·æ±‚ï¼Œéƒ½ä¼šè¿”å›arp reply</li>
</ul>

<p>è¿™é‡Œæˆ‘ä»¬æ¥æŠ“åŒ…çœ‹çœ‹ï¼Œå…ˆçœ‹çœ‹å®¹å™¨åˆ†å¸ƒï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>[root@node1 ~]# kubectl get pods -owide |grep 11.244.104.3
sectest-app-influxdb-deployment-6df667cd75-bmkk5    1/1     Running     4          2d23h   11.244.104.3     node2   &lt;none&gt;           &lt;none&gt;
[root@node1 ~]# kubectl get pods -owide |grep 11.244.104.7
sectest-app-rabbitmq-deployment-545f49dd55-bp5tl    1/1     Running     4          2d23h   11.244.104.7     node2   &lt;none&gt;           &lt;none&gt;
[root@node1 ~]# kubectl get pods -owide |grep 11.244.135.31
sectest-app-haproxy-deployment-58bfd8b4b-29f79      1/1     Running     2          2d23h   11.244.135.31    node3   &lt;none&gt;           &lt;none&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¹å™¨åŒèŠ‚ç‚¹é€šä¿¡æŠ“åŒ…ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on calic4eb42dc79d, link-type EN10MB (Ethernet), capture size 262144 bytes
14:10:55.717915 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype ARP (0x0806), length 42: Request who-has 169.254.1.1 tell 11.244.104.3, length 28
14:10:55.717943 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype ARP (0x0806), length 42: Reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee, length 28
14:10:56.705970 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 11.244.104.3 &gt; 11.244.104.7: ICMP echo request, id 10, seq 7, length 64
14:10:56.706026 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype IPv4 (0x0800), length 98: 11.244.104.7 &gt; 11.244.104.3: ICMP echo reply, id 10, seq 7, length 64
14:10:57.705969 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 11.244.104.3 &gt; 11.244.104.7: ICMP echo request, id 10, seq 8, length 64
14:10:57.706019 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype IPv4 (0x0800), length 98: 11.244.104.7 &gt; 11.244.104.3: ICMP echo reply, id 10, seq 8, length 64
14:10:58.705990 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 11.244.104.3 &gt; 11.244.104.7: ICMP echo request, id 10, seq 9, length 64
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¹å™¨è·¨èŠ‚ç‚¹é€šä¿¡æŠ“åŒ…ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>14:10:08.101925 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype ARP (0x0806), length 42: Request who-has 169.254.1.1 tell 11.244.104.3, length 28
14:10:08.101948 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype ARP (0x0806), length 42: Reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee, length 28
14:10:09.093021 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 11.244.104.3 &gt; 11.244.135.31: ICMP echo request, id 9, seq 7, length 64
14:10:09.093406 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype IPv4 (0x0800), length 98: 11.244.135.31 &gt; 11.244.104.3: ICMP echo reply, id 9, seq 7, length 64
14:10:10.093016 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 11.244.104.3 &gt; 11.244.135.31: ICMP echo request, id 9, seq 8, length 64
14:10:10.093386 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype IPv4 (0x0800), length 98: 11.244.135.31 &gt; 11.244.104.3: ICMP echo reply, id 9, seq 8, length 64
14:10:11.093573 d6:84:ed:49:d4:cf &gt; ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 11.244.104.3 &gt; 11.244.135.31: ICMP echo request, id 9, seq 9, length 64
14:10:11.093910 ee:ee:ee:ee:ee:ee &gt; d6:84:ed:49:d4:cf, ethertype IPv4 (0x0800), length 98: 11.244.135.31 &gt; 11.244.104.3: ICMP echo reply, id 9, seq 9, length 64
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨arpè¯·æ±‚169.254.1.1åï¼Œåœ¨ä¸»æœºä¸­çš„vethè®¾å¤‡ä¼šè¿”å›arp replyåŒ…ï¼Œå®¹å™¨å†…éƒ¨ä¼šç”Ÿæˆä¸€æ¡neighä¿¡æ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>[root@node2 ~]# docker exec -it d3d044626d12 sh
# ip neigh
169.254.1.1 dev eth0 lladdr ee:ee:ee:ee:ee:ee STALE
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
  <li>ä»æŠ“åŒ…ç»“æœçœ‹äºŒå±‚é€šä¿¡å’Œä¸‰å±‚é€šä¿¡çš„ç»“æœéƒ½æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½ä¼šå…ˆarpè¯·æ±‚ç½‘å…³169.254.1.1ï¼Œå†å°†åŒ…è½¬å‘åˆ°ç½‘å…³è®¾å¤‡ã€‚ä¹Ÿå°±æ˜¯å°†äºŒå±‚å’Œä¸‰å±‚é€šä¿¡éƒ½é€šè¿‡ä¸‰å±‚è¿›è¡Œè½¬å‘</li>
  <li>æ•°æ®åŒ…åˆ°è¾¾ä¸»æœºä¸Šçš„vethè®¾å¤‡ï¼ˆå®¹å™¨è®¤ä¸ºçš„ç½‘å…³ï¼‰åï¼Œæ ¹æ®ä¸»æœºä¸Šçš„è·¯ç”±è¿›è¡Œè½¬å‘å³å¯</li>
  <li>ä¸»æœºè·¯ç”±æ˜¯ç”±bgpï¼ˆbirdï¼‰æœåŠ¡ç»´æŠ¤çš„</li>
  <li>ç”±äºarpåœ¨hostçš„vethå°±ç»ˆç»“äº†ï¼ˆarpä»£ç­”çš„åŠŸåŠ³ï¼‰ï¼Œè¿™ç§å®ç°æœ‰æ•ˆå±è”½çš„arpå¹¿æ’­ï¼Œé™ä½å¹¿æ’­é£æš´çš„å¨èƒ</li>
</ul>
:ET
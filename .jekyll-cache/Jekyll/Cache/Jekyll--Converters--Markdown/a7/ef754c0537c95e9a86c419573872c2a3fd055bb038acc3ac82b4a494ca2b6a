I"ä(<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>Docker-CEåˆ†æ”¯åœ¨v20.10ç‰ˆæœ¬ä¹‹åå°†ä¼šåœæ­¢æ›´æ–°ï¼ŒåŸå…ˆçš„docker-ceå°†æ‹†åˆ†æˆdocker/cliå’Œmoby/mobyä¸¤ä¸ªé¡¹ç›®ï¼Œå…¶ä¸­docker/cliå°±æ˜¯dockerçš„å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„dockerå‘½ä»¤è¡Œå·¥å…·æ‰€å±çš„é¡¹ç›®ï¼›moby/mobyé¡¹ç›®å°±æ˜¯åŸå…ˆdocker engineçš„éƒ¨åˆ†</p>

<h2 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h2>

<p>åœ¨ç¼–è¯‘dockeræºç ä¹‹å‰ï¼Œéœ€è¦å®‰è£…docker-ce</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>yum install docker-ce -y
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è·å–é¡¹ç›®ä»£ç ">è·å–é¡¹ç›®ä»£ç </h2>

<p>æ ¹æ®éœ€æ±‚è·å–æœ€æ–°çš„docker/cliå’Œmoby/mobyé¡¹ç›®ä»£ç å’Œåˆ‡æ¢ç‰ˆæœ¬</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>cd /root
git clone https://github.com/docker/cli.git
cd cli &amp;&amp; git checkout v20.10.7
git clone https://github.com/moby/moby.git
cd moby &amp;&amp; git checkout v20.10.7
git clone https://github.com/docker/scan-cli-plugin.git
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>æ ¹æ®å®é™…æƒ…å†µé€‚å½“ç¿»å¢™æˆ–è€…ä½¿ç”¨å›½å†…åŠ é€Ÿä¼˜åŒ–æ–¹å¼</p>
</blockquote>

<h3 id="å¯é€‰ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶">ã€å¯é€‰ã€‘ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶</h3>

<p>åˆ‡æ¢åˆ†æ”¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>cd cli
git chekout 20.10

cd moby
git checkout 20.10
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼–è¯‘cli</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make -f docker.Makefile binary
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>åœ¨buildç›®å½•ä¸‹æ˜¯ç¼–è¯‘å¥½çš„æ–‡ä»¶</p>
</blockquote>

<p>ç¼–è¯‘moby</p>

<p>åœ¨git cloneä¹‹å‰æ·»åŠ ä»£ç†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>hack/dockerfile/install/containerd.installer
hack/dockerfile/install/dockercli.installer
hack/dockerfile/install/proxy.installer
hack/dockerfile/install/rootlesskit.installer
hack/dockerfile/install/runc.installer
hack/dockerfile/install/shfmt.installer
hack/dockerfile/install/tini.installer
hack/dockerfile/install/tomlv.installer
hack/dockerfile/install/vndr.installe
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼–è¯‘</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make binary
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>åœ¨bundles/binary-daemon/ç›®å½•ä¸‹æ˜¯ç¼–è¯‘å¥½çš„æ–‡ä»¶</p>
</blockquote>

<p>éªŒè¯ï¼Œåœæ­¢èŠ‚ç‚¹ä¸Šçš„docker</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>systemctl stop docker.service
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å°†ä¹‹å‰ç¼–è¯‘çš„dockerå’Œdockerdæ›¿æ¢</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>mv /usr/bin/docker /home/backup
cp cli/build/docker /usr/bin/docker
chmod +x /usr/bin/docker

mv /usr/bin/dockerd /home/backup
cp moby/bundles/binary-daemon/dockerd /usr/bin/dockerd
chmod +x /usr/bin/dockerd
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯åŠ¨docker</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>systemctl start docker.service

docker version
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯åŠ¨æµ‹è¯•å®¹å™¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>docker pull alpine
docker run alpine echo "hello from alpine"
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ç¼–è¯‘rpmåŒ…">ç¼–è¯‘RPMåŒ…</h3>

<p>è·å–æ‰“åŒ…é¡¹ç›®ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git clone https://github.com/docker/docker-ce-packaging.git
cd docker-ce-packaging
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ã€å¯é€‰ã€‘æ ¹æ®éœ€æ±‚åˆ‡æ¢åˆ†æ”¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git checkout v20.10.0-beta1
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>æ³¨æ„ï¼šè¿™é‡Œçš„ç‰ˆæœ¬å»ºè®®å’Œdocker/cliç­‰é¡¹ç›®é€‡ç‰ˆæœ¬ä¿æŒä¸€è‡´</p>
</blockquote>

<p>åˆ›å»ºä»£ç ç›®å½•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mkdir -p src/github.com/docker/
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å°†ä¸Šé¢git cloneä¸‹æ¥çš„ä»£ç æ”¾åˆ°å¯¹åº”ç›®å½•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>cp -r /root/cli src/github.com/docker/
cp -r /root/moby src/github.com/docker/docker # è¿™é‡Œä¸€å®šè¦æ”¹æˆdockeråç§°ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸€ç³»åˆ—é”™è¯¯
cp -r /root/scan-cli-plugin src/github.com/docker/
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨å¯¹åº”é¡¹ç›®é‡Œæ ¹æ®éœ€æ±‚åˆ‡æ¢åˆ†æ”¯æˆ–è€…ä¿®æ”¹ä»£ç </p>

<p>ã€å¯é€‰ã€‘è®¾ç½®dockeré¡¹ç›®httpsä»£ç†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>vi ./src/github.com/docker/docker/hack/dockerfile/install/runc.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/containerd.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/dockercli.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/proxy.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/rootlesskit.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/runc.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/shfmt.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/tini.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/tomlv.installer
vi ./src/github.com/docker/docker/hack/dockerfile/install/vndr.installer
vi ./src/github.com/docker/docker/vendor/github.com/docker/libnetwork/network.go

vi rpm/SPECS/docker-ce-cli.spec
...
%build
export https_proxy=http://10.51.30.48:1080
...
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¼€å§‹ç¼–è¯‘(æ ¹æ®éœ€æ±‚é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬å’Œç³»ç»Ÿ)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cd rpm
VERSION=20.10.7 make centos-7
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç”Ÿæˆçš„æ–‡ä»¶åœ¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>[root@localhost rpm]# pwd
/root/docker-ce-packaging/rpm
[root@localhost rpm]# ll rpmbuild/centos-7/RPMS/x86_64
total 65428
-rw-r--r-- 1 root root 23793492 Oct 20 18:47 docker-ce-20.10.7.chinac-3.el7.x86_64.rpm
-rw-r--r-- 1 root root 31183248 Oct 20 18:51 docker-ce-cli-20.10.7.chinac-3.el7.x86_64.rpm
-rw-r--r-- 1 root root  8424840 Oct 20 18:52 docker-ce-rootless-extras-20.10.7.chinac-3.el7.x86_64.rpm
-rw-r--r-- 1 root root  3591600 Oct 20 18:53 docker-scan-plugin-0.8.0-3.el7.x86_64.rpm  
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="clicomposeschemaschemago42-cannot-find-package-embed-in-any-of">cli/compose/schema/schema.go:4:2: cannot find package â€œembedâ€ in any of:</h3>
<p>ä½ç‰ˆæœ¬çš„golangä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹ç¼–è¯‘æ—¶æŒ‡å®šçš„golangç‰ˆæœ¬</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>vi common.tk
...
GO_VERSION=1.16.9 &gt; æ³¨æ„ï¼šä¸æ˜¯å‡çº§æœ¬åœ°çš„golangï¼Œæ˜¯å®¹å™¨ä¸­çš„ï¼Œæ‰€ä»¥åªéœ€è¦æ”¹ä¸‹è¿™ä¸ªæ–‡ä»¶
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
  <li>https://openpower.ic.unicamp.br/post/building-docker-for-power/</li>
  <li>https://www.fatalerrors.org/a/pull-and-compile-docker-ce.html</li>
</ul>
:ET